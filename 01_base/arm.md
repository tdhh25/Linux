
## ARM体系结构与编程

死磕第1-4章+第6-8章，第9章异常处理必读，强化第5章（MMU/Cache）、第9章（中断）、第11章（Scatter文件）

### 基本编程模型

#### ARM处理器的运行模式

1. 7种运行模式

|处理器模式|描述|
|---|---|
|用户模式（User,usr）|正常程序执行的模式|
|快速中断模式（FIQ,fiq）|用于高速数据传输和通道处理|
|外部中断模式（IRQ,irq）|用于通常的中断处理|
|特权模式（Supervisor,sve）|供操作系统使用的一种保护模式|
|数据访问终止模式（Abort,abt）|用于虚拟存储及存储保护|
|未定义指令中止模式（Undefined ,und）|用于支持通过软件仿真硬件的协处理器|
|系统模式（System , sys）|用于运行特权级的操作系统任务|

特权模式：除用户模式以外的6种模式，程序可以访问所以的系统资源
异常模式：除用户模式，系统模式以外的5种模式

2. 模式切换机制

- 硬件自动切换
&emsp;运行在用户模式时，当发生以下事件时，硬件强制切换模式并保存返回地址到对应LR

|事件|目标模式|LR保存地址|返回指令|
|---|---|---|---|
|FIQ中断|FIQ|R14_fiq|SUBS PC, LR, #4|
|IRQ中断|IRQ|R14_irq|SUBS PC, LR, #4|
|SWI指令调用|SVC|R14_svc|MOVS PC, LR|
|指令预取中止|Abort|R14_abt|SUBS PC, LR, #4|
|数据访问中止|Abort|R14_abt|SUBS PC, LR, #8|
|未定义指令|Undef|R14_und|MOVS PC, LR|

- 软件手动切换
&emsp;在特权模式下，通过修改CPSR[4:0] 位直接切换模式
```assembly
MRS R0, CPSR                  ; 读取CPSR
BIC R0, R0, #0x1F             ; 清除模式位[4:0]
ORR R0, R0, #0x1F             ; 设置System模式（0x1F）
MSR CPSR_c, R0                ; 写回CPSR（仅控制域）
```

#### ARM寄存器

ARM有37个寄存器：
&emsp;即加粗（特权模式特有的）部分 + R0~R15 + CPSR

| 寄存器 | 用户模式 (User) | 系统模式 (System) | FIQ 模式      | IRQ 模式      | SVC 模式      | Abort 模式    | Undef 模式    |
|--------|-----------------|------------------|---------------|---------------|---------------|--------------|--------------|
| **R0** | R0             | R0              | R0            | R0            | R0            | R0           | R0           |
| **R1** | R1             | R1              | R1            | R1            | R1            | R1           | R1           |
| **R2** | R2             | R2              | R2            | R2            | R2            | R2           | R2           |
| **R3** | R3             | R3              | R3            | R3            | R3            | R3           | R3           |
| **R4** | R4             | R4              | R4            | R4            | R4            | R4           | R4           |
| **R5** | R5             | R5              | R5            | R5            | R5            | R5           | R5           |
| **R6** | R6             | R6              | R6            | R6            | R6            | R6           | R6           |
| **R7** | R7             | R7              | R7            | R7            | R7            | R7           | R7           |
| **R8** | R8             | R8              | **R8_fiq**    | R8            | R8            | R8           | R8           |
| **R9** | R9             | R9              | **R9_fiq**    | R9            | R9            | R9           | R9           |
| **R10**| R10            | R10             | **R10_fiq**   | R10           | R10           | R10          | R10          |
| **R11**| R11            | R11             | **R11_fiq**   | R11           | R11           | R11          | R11          |
| **R12**| R12            | R12             | **R12_fiq**   | R12           | R12           | R12          | R12          |
| **R13**| R13 (SP_usr)   | R13 (SP_usr)    | **R13_fiq**   | **R13_irq**   | **R13_svc**   | **R13_abt**  | **R13_und**  |
| **R14**| R14 (LR_usr)   | R14 (LR_usr)    | **R14_fiq**   | **R14_irq**   | **R14_svc**   | **R14_abt**  | **R14_und**  |
| **R15**| R15 (PC)       | R15 (PC)        | R15 (PC)      | R15 (PC)      | R15 (PC)      | R15 (PC)     | R15 (PC)     |
| **CPSR**| CPSR          | CPSR            | CPSR          | CPSR          | CPSR          | CPSR         | CPSR         |
| **SPSR**| -              | -               | **SPSR_fiq**  | **SPSR_irq**  | **SPSR_svc**  | **SPSR_abt** | **SPSR_und** |
| **总计**| 17 寄存器     | 17 寄存器       | **24 寄存器** | 20 寄存器     | 20 寄存器     | 20 寄存器    | 20 寄存器    |

##### 通用寄存器
通用寄存器分为三类：
&emsp;未备份寄存器
&emsp;备份寄存器
&emsp;程序计数器

- 未备份寄存器
  - r0~r7
  - 在所有处理器模式下，使用同一个物理寄存器，可能造成寄存器中数据被破坏

- 备份寄存器
  - r8~r14
  - r8~r12，每个寄存器对应两个不同的物理寄存器。以r8和r9为例，快速中断模式下是r8_fiq, r9_fiq，使用这两个寄存器时，fiq程序可以不必执行保存和恢复中断现场的指令，使得中断处理非常迅速
  - r13，ARM中常用作栈指针，每一个异常模式都有自己的物理r13，r13由应用程序初始化，指向该异常模式专用的栈地址
  - r14，连接寄存器
    - 每一种处理器模式自己的r14存放着当前子程序的返回地址，mov pc, lr/bx lr可以实现子程序的返回
    - 当异常中断发生时，该异常模式特定的r14被设置成该异常模式将要返回的地址。对于有些异常模式，r14的值可能是返回地址的一个偏移

- 程序计数器
  - pc
  - 由于ARM的流水线机制，当正确读取pc的值时，pc = current_address + 8
  - 使用str/stm保存r15时，保存的可能是当前地址加8，也有可能是当前地址加12

##### 程序状态寄存器
- cpsr可以在任意处理器模式下访问
- 每种异常模式都有一个专用的SPSR（备份程序状态寄存器）。当特定的异常中断发生时，保存CPSR的内容到SPSR，异常中断程序退出时，用SPSR恢复CPSR
- CPSR和SPSR的格式如下

|31|30|29|28|27|26~8|7|6|5|4|3|2|1|0|
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
|N|Z|C|V|Q|DNM(RAZ)|I|F|T|M4|M3|M2|M1|M0|

- 条件标志位
    - N  1：负数，0：正数
    - Z  1：结果为0，0：结果不为0
    - C
    - V
- Q标志位
&emsp;指示增强的DSP指令是否发生溢出
- 控制位
  - I   1: 禁止IRQ中断
  - F   1：禁止FIQ中断
  - T   1：Thumb指令 0：ARM指令
  - M[4:0]
    - 0b10000 user模式
    - 0b10001 FIQ模式
    - 0b10010 IRQ模式
    - 0b10011 Supervisor模式
    - 0b10111 Abort模式
    - 0b11011 Undefined模式
    - 0b11111 System模式

### 寻址方式

#### 数据处理指令的操作数的寻址方式
```shell
<opcode> {<cond>} {S} <Rd>,<Rn>,<shifter_operand>
```

shifter_operand有三种方式：
- 立即数，每个立即数由一个8位的常数循环右移偶数位得到，即< immediate > = immed_8循环右移（2 * rotate_imm）
    - 当立即数范围在0~0xff范围中时，immed_8 = < immediate > rotate_imm = 0
    - 其他情况，选择rotate_imm数值最小的编码方式

- 寄存器 ，操作数为寄存器的数值
- 寄存器移位

### ARM指令集
ARM指令可以分为6种：跳转指令、数据处理指令、程序状态寄存器传输指令、Load/Store指令、协处理器指令以及异常中断产生指令

#### 跳转指令

&emsp;ARM中有两种方法可以实现程序的跳转：
&emsp;&emsp;(1)跳转指令，当前指令向前/向后32MB的地址空间跳转
&emsp;&emsp;(2)pc寄存器写入目标地址值，4G地址上任意跳转
  
- B/BL，跳转指令

| 位域 | 31~28 | 27~25 | 24 | 23~0 |
|------|-------|-------|----|------|
| **含义** | `cond` | `101` | `L` | `signed_immed_24` |

&emsp;语法格式：
&emsp;&emsp;B {L} {< cond >} < target_address >
&emsp;当有L的时候，PC的值将保存到LR寄存器